# Warning: there won't be any resource requests/limits for any Loki-related container
---
serviceAccount: # There is no way to set an account per component
  create: true
  name: loki-sa

test:
  enabled: false

lokiCanary:
  enabled: false

sidecar:
  rules: # Rules stored on S3
    enabled: false

gateway:
  service:
    labels:
      prometheus.io/service-monitor: 'false' # nginx exporter unavailable

loki:
  auth_enabled: true
  commonConfig:
    path_prefix: /var/loki
  storage:
    type: s3
    s3:
      endpoint: minio.storage.svc:9000
      accessKeyId: remote_user
      secretAccessKey: R3m0t3us3r
      insecure: true
      s3ForcePathStyle: true
    bucketNames:
      chunks: loki-data
      ruler: loki-ruler
  storage_config:
    tsdb_shipper:
      active_index_directory: /var/loki/tsdb-shipper-active
      cache_location: /var/loki/tsdb-shipper-cache
      cache_ttl: 24h
  rulerConfig:
    alertmanager_url: http://monitor-alertmanager.observability.svc:9093
    enable_alertmanager_v2: true
    enable_sharding: true
  schemaConfig:
    configs:
    - from: '2024-04-08'
      store: tsdb
      object_store: s3
      schema: v13
      index:
        period: 24h
        prefix: loki_index_
  limits_config:
    ingestion_rate_mb: 10
    retention_period: 7d # Global Logs TTL
    # Enable structured metadata support (Loki 3.0+)
    allow_structured_metadata: true
    # Maximum size of structured metadata per log line (default: 64KB)
    max_structured_metadata_size: 65536
    # Maximum number of structured metadata entries per log line
    max_structured_metadata_entries_count: 128
    # Add query timeout to prevent long-running queries (must be in limits_config)
    query_timeout: 5m
  ingester:
    max_chunk_age: 1h
  querier:
    query_ingesters_within: 2h
  query_range:
    # Enable result caching for better performance
    results_cache:
      cache:
        embedded_cache:
          enabled: true
          max_size_mb: 100
  compactor:
    working_directory: /var/loki/compactor
    delete_request_store: s3
    retention_enabled: true
    delete_request_cancel_period: 5m
    retention_delete_delay: 5m
  distributor:
    # Enable OTLP ingestion using Loki's default OTLP configuration
    otlp_config: {}

resultsCache:
  allocatedMemory: 512
  resources:
    requests:
      cpu: 25m

chunksCache:
  enabled: true
  replicas: 1
  allocatedMemory: 1024
  resources:
    requests:
      cpu: 25m

metaMonitoring:
  serviceMonitor:
    enabled: true
    labels:
      release: monitor
  dashboards:
    enabled: true
    labels:
      release: monitor
  prometheusRule:
    enabled: true
    labels:
      release: monitor
